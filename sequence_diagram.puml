@startuml Voice_Agent_Interaction_Flow
!theme plain
skinparam sequenceMessageAlign center
skinparam lifelineStrategy solid

title Tamil Voice Agent - Interaction Flow Sequence Diagram

actor User
participant "Streamlit UI\n(streamlit_app.py)" as UI
participant "Audio Service\n(audio.py)" as Audio
participant "STT Service\n(stt.py)" as STT
participant "Intent Service\n(intent.py)" as Intent
participant "Agent State\n(agent_state.py)" as State
participant "Planner\n(planner.py)" as Planner
participant "Eligibility Service\n(eligibility.py)" as Eligibility
participant "Documents Service\n(documents.py)" as Documents
participant "Questions Service\n(questions.py)" as Questions
participant "TTS Service\n(tts.py)" as TTS
database "Schemes Data\n(schemes.json)" as Schemes
cloud "Whisper API" as Whisper
cloud "Gemini API" as Gemini
cloud "gTTS API" as gTTS

== Voice Input Phase ==
User -> UI: Click "Start Recording"
UI -> Audio: record_until_silence()
Audio -> Audio: Detect silence
Audio --> UI: audio_path
UI -> UI: Auto-process triggered

== STT Phase ==
UI -> STT: speech_to_text(audio_path)
STT -> Whisper: Transcribe Tamil speech
Whisper --> STT: Transcription result
STT -> STT: Calculate confidence
STT --> UI: (text, confidence)

== NLU Phase ==
UI -> Intent: extract_intent_and_slots(text)
Intent -> Gemini: Extract intent & slots
Gemini --> Intent: NLU result (JSON)
Intent --> UI: {intent, slots, confidence}

== State Update Phase ==
UI -> State: update_state_from_nlu(state, nlu_result)
State -> State: Update slots, detect contradictions
State --> UI: Updated state

== Planning Phase ==
UI -> Planner: decide_next_action(state, stt_confidence)
Planner -> Planner: Check STT confidence
Planner -> Planner: Check contradictions
Planner -> Planner: Get candidate schemes
Planner -> Planner: Check missing slots
Planner -> Schemes: Read scheme rules
Schemes --> Planner: Scheme definitions
Planner --> UI: (action, info)

== Action Execution Phase ==

alt CHECK_ELIGIBILITY
    UI -> Eligibility: check_eligibility(slots)
    Eligibility -> Schemes: Read eligibility rules
    Schemes --> Eligibility: Rules & required fields
    Eligibility -> Eligibility: Evaluate rules (==, >=, <=, between)
    Eligibility --> UI: Eligible schemes with Tamil reasons
    UI -> State: Update eligible_schemes
end

alt CHECK_DOCUMENTS
    UI -> Documents: check_document_readiness(documents)
    Documents -> Schemes: Get required documents
    Schemes --> Documents: Document list
    Documents --> UI: Document status
    UI -> Questions: ask_for_document(doc_name)
    Questions --> UI: Tamil question
end

alt ASK_MISSING_SLOT
    UI -> Questions: ask_for_slot(slot_name)
    Questions --> UI: Tamil question
end

alt HANDLE_CONTRADICTION
    UI -> Questions: handle_contradiction(slot, prev, new)
    Questions -> Gemini: Generate clarification message
    Gemini --> Questions: Tamil clarification
    Questions --> UI: Clarification message
end

alt APPLY_SCHEME
    UI -> Application: apply_for_scheme(scheme_id, slots)
    Application -> Application: Generate mock application_id
    Application --> UI: {status, application_id}
    UI -> State: Update application status
end

== Response Generation Phase ==
UI -> TTS: text_to_speech(response_text)
TTS -> gTTS: Generate Tamil speech
gTTS --> TTS: Audio file
TTS --> UI: audio_path
UI -> UI: Auto-play audio
UI --> User: Play response audio

== Document Response Flow (Context-Aware) ==
alt Document Question Asked
    User -> UI: Say "ஆம்" (yes) or "இல்லை" (no)
    UI -> STT: speech_to_text()
    STT -> Whisper: Transcribe
    Whisper --> STT: Text
    STT --> UI: (text, confidence)
    UI -> NLUUtils: extract_yes_no_from_tamil(text)
    NLUUtils --> UI: "yes" or "no"
    UI -> State: Update document state
    UI -> Documents: check_document_readiness()
    Documents --> UI: Next document or ready
    alt More documents needed
        UI -> Questions: ask_for_document(next_doc)
        Questions --> UI: Next question
    else All documents ready
        UI -> Questions: confirm_application()
        Questions --> UI: Confirmation question
    end
end

@enduml

