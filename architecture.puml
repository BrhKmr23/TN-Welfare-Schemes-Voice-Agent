@startuml TN_Welfare_Schemes_Voice_Agent_Architecture
!theme plain
skinparam componentStyle rectangle
skinparam linetype ortho

title Tamil Welfare Schemes Voice Agent - System Architecture

package "User Interface Layer" {
    component [Streamlit UI\nstreamlit_app.py] as UI
}

package "Application Core Layer" {
    component [Agent State\nagent_state.py] as AgentState
    component [Planner\nplanner.py] as Planner
    component [Config\nconfig.py] as Config
}

package "Service Layer" {
    package "Audio Services" {
        component [Audio Service\naudio.py] as Audio
        component [STT Service\nstt.py] as STT
        component [TTS Service\ntts.py] as TTS
    }
    
    package "NLU Services" {
        component [Intent Service\nintent.py] as Intent
        component [NLU Utils\nnlu_utils.py] as NLUUtils
        component [Questions Service\nquestions.py] as Questions
    }
    
    package "Business Logic Services" {
        component [Eligibility Service\neligibility.py] as Eligibility
        component [Documents Service\ndocuments.py] as Documents
        component [Application Service\napplication.py] as Application
    }
}

package "Data Layer" {
    database [Schemes Data\nschemes.json] as Schemes
}

package "External Services" {
    cloud [OpenAI Whisper\nSTT API] as Whisper
    cloud [Google Gemini\nLLM API] as Gemini
    cloud [Google TTS\ngTTS API] as gTTS
}

package "Utilities" {
    component [API Key Checker\ncheck_api_key.py] as APIKeyCheck
}

' User Flow - Voice Input
UI --> Audio : "1. Record voice"
Audio --> STT : "2. Audio file"
STT --> Whisper : "3. Transcribe"
STT --> UI : "4. Text + Confidence"

' User Flow - NLU
UI --> Intent : "5. User text"
Intent --> Gemini : "6. Extract intent & slots"
Intent --> UI : "7. NLU result"

' User Flow - State Management
UI --> AgentState : "8. Update state"
AgentState --> Planner : "9. Current state"
Planner --> Config : "10. Get config"
Planner --> Schemes : "11. Get scheme rules"

' User Flow - Eligibility Check
Planner --> Eligibility : "12. Check eligibility"
Eligibility --> Schemes : "13. Read rules"
Eligibility --> Planner : "14. Eligible schemes"

' User Flow - Document Check
Planner --> Documents : "15. Check documents"
Documents --> Schemes : "16. Get required docs"
Documents --> Planner : "17. Document status"

' User Flow - Question Generation
Planner --> Questions : "18. Generate questions"
Questions --> Gemini : "19. Phrase contradictions"
Questions --> UI : "20. Tamil questions"

' User Flow - Application
Planner --> Application : "21. Apply scheme"
Application --> UI : "22. Application result"

' User Flow - Response Generation
UI --> TTS : "23. Agent response"
TTS --> gTTS : "24. Generate speech"
TTS --> UI : "25. Audio file"

' Service Dependencies
Intent --> NLUUtils : "Extract yes/no"
Questions --> NLUUtils : "Parse responses"
Documents --> NLUUtils : "Parse yes/no"

' Configuration
Config --> Audio : "Recording params"
Config --> STT : "Model config"
Config --> TTS : "Language config"

' Utility
APIKeyCheck --> Gemini : "Verify API key"

note right of UI
    **Main Responsibilities:**
    - Voice input recording
    - Conversation display
    - Agent state visualization
    - Auto-processing pipeline
    - Auto-play responses
end note

note right of AgentState
    **State Management:**
    - Intent tracking
    - Slot management
    - Document state
    - Contradiction detection
    - Application status
end note

note right of Planner
    **Decision Logic:**
    - Decision table implementation
    - Scheme pre-filtering
    - Action selection
    - Candidate scheme identification
    - Context-aware routing
end note

note right of Schemes
    **Data Structure:**
    - Scheme definitions
    - Eligibility rules (==, >=, <=, between)
    - Required documents
    - Scheme metadata
    - Tamil names
end note

@enduml

